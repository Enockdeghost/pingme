{% extends "base.html" %}

{% block title %}{{ user.username }} - Chatter{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Profile Header -->
         
        <div class="position-relative">
            <!-- Cover Photo -->
            <div class="bg-secondary" style="height: 200px;"></div>
            
            <!-- Profile Info -->
            <div class="px-4 pb-4">
                <div class="d-flex justify-content-between align-items-start">
                    <!-- Profile Picture -->
                    <div class="position-relative">
                        <img src="{{ url_for('static', filename='uploads/profiles/' + user.profile_picture) }}" 
                             class="avatar border-4 border-dark rounded-circle" 
                             style="width: 120px; height: 120px; margin-top: -60px; border-width: 4px !important;"
                             onerror="this.src='https://via.placeholder.com/120'">
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-3">
                        {% if user.id == current_user.id %}
                        <a href="{{ url_for('edit_profile') }}" class="btn btn-outline-light rounded-pill px-4">
                            Edit profile
                        </a>
                        {% else %}
                        <button class="btn {% if current_user.is_following(user) %}btn-outline-light{% else %}btn-primary{% endif %} rounded-pill px-4 follow-btn" 
                                data-user-id="{{ user.id }}">
                            {% if current_user.is_following(user) %}Following{% else %}Follow{% endif %}
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- User Info -->
                <div class="mt-3">
                    <h4 class="fw-bold mb-1">{{ user.username }}</h4>
                    <p class="text-muted mb-3">@{{ user.username }}</p>
                    
                    {% if user.bio %}
                    <p class="mb-3">{{ user.bio }}</p>
                    {% endif %}

                    <div class="d-flex text-muted">
                        <div class="me-4">
                            <span class="fw-bold text-light">{{ user.followed.count() }}</span>
                            <span class="ms-1">Following</span>
                        </div>
                        <div>
                            <span class="fw-bold text-light">{{ user.followers.count() }}</span>
                            <span class="ms-1">Followers</span>
                        </div>
                        <div class="ms-4">
                            <span class="fw-bold text-light">{{ total_likes }}</span>
                            <span class="ms-1">Likes</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Posts Tabs -->
        <div class="border-top border-secondary">
            <nav>
                <div class="nav nav-tabs border-0" id="nav-tab" role="tablist">
                    <button class="nav-link active border-0 text-light py-3" data-bs-toggle="tab" data-bs-target="#posts" type="button">
                        Posts
                    </button>
                    <button class="nav-link border-0 text-light py-3" data-bs-toggle="tab" data-bs-target="#replies" type="button">
                        Replies
                    </button>
                    <button class="nav-link border-0 text-light py-3" data-bs-toggle="tab" data-bs-target="#media" type="button">
                        Media
                    </button>
                    <button class="nav-link border-0 text-light py-3" data-bs-toggle="tab" data-bs-target="#likes" type="button">
                        Likes
                    </button>
                </div>
            </nav>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="posts">
                    {% for post in posts %}
                    <div class="post-card">
                        <div class="d-flex">
                            <img src="{{ url_for('static', filename='uploads/profiles/' + post.author.profile_picture) }}" 
                                 class="avatar me-3" onerror="this.src='https://via.placeholder.com/48'">
                            
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <div>
                                        <span class="fw-bold">{{ post.author.username }}</span>
                                        <span class="text-muted ms-2">@{{ post.author.username }}</span>
                                        <span class="text-muted ms-2">Â·</span>
                                        <span class="text-muted">{{ post.created_at.strftime('%b %d') }}</span>
                                    </div>
                                </div>

                                <div class="post-content mb-3">
                                    {{ post.content | process_content | safe }}
                                </div>

                                {% if post.image %}
                                <div class="post-image mb-3">
                                    <img src="{{ url_for('static', filename='uploads/posts/' + post.image) }}" 
                                         class="img-fluid rounded-3" style="max-height: 400px; width: auto;">
                                </div>
                                {% endif %}

                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn action-btn">
                                        <i class="far fa-comment"></i>
                                        <span class="ms-1">{{ post.comment_count() }}</span>
                                    </button>

                                    <button class="btn action-btn">
                                        <i class="fas fa-retweet"></i>
                                        <span class="ms-1">0</span>
                                    </button>

                                    <button class="btn action-btn like-btn {% if post.likes.filter_by(user_id=current_user.id).first() %}liked{% endif %}" 
                                            data-post-id="{{ post.id }}">
                                        <i class="{% if post.likes.filter_by(user_id=current_user.id).first() %}fas{% else %}far{% endif %} fa-heart"></i>
                                        <span class="ms-1 like-count">{{ post.like_count() }}</span>
                                    </button>

                                    <button class="btn action-btn">
                                        <i class="far fa-share-square"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-feather-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No posts yet</h5>
                        {% if user.id == current_user.id %}
                        <p class="text-muted">When you post, they'll show up here.</p>
                        {% else %}
                        <p class="text-muted">When @{{ user.username }} posts, they'll show up here.</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}